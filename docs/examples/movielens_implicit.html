

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>An implicit feedback recommender for the Movielens dataset &mdash; LightFM 1.9 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="LightFM 1.9 documentation" href="../index.html"/>
        <link rel="up" title="Examples" href="../examples.html"/>
        <link rel="next" title="Using different learning schedules" href="learning_schedules.html"/>
        <link rel="prev" title="Examples" href="../examples.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        

        
          <a href="../index.html" class="icon icon-home"> LightFM
        

        
        </a>

        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../home.html">Home</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../home.html#quickstart">Quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../home.html#installation">Installation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../home.html#pypi">PyPI</a></li>
<li class="toctree-l3"><a class="reference internal" href="../home.html#using-with-docker">Using with Docker</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../home.html#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../home.html#examples">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../home.html#development">Development</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lightfm.html">LightFM model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lightfm.evaluation.html">Model evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../datasets.html">Datasets</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../examples.html">Examples</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Movielens implicit feedback recommender</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#implicit-feedback">Implicit feedback</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-the-data">Getting the data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fitting-models">Fitting models</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="learning_schedules.html">Learning rate schedules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="learning_schedules.html#preliminaries">Preliminaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="learning_schedules.html#experiment">Experiment</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="hybrid_crossvalidated.html">Cold-start hybrid recommender</a><ul>
<li class="toctree-l3"><a class="reference internal" href="hybrid_crossvalidated.html#a-pure-collaborative-filtering-model">A pure collaborative filtering model</a></li>
<li class="toctree-l3"><a class="reference internal" href="hybrid_crossvalidated.html#a-hybrid-model">A hybrid model</a></li>
<li class="toctree-l3"><a class="reference internal" href="hybrid_crossvalidated.html#bonus-tag-embeddings">Bonus: tag embeddings</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">LightFM</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../examples.html">Examples</a> &raquo;</li>
      
    <li>An implicit feedback recommender for the Movielens dataset</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/examples/movielens_implicit.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="an-implicit-feedback-recommender-for-the-movielens-dataset">
<h1>An implicit feedback recommender for the Movielens dataset<a class="headerlink" href="#an-implicit-feedback-recommender-for-the-movielens-dataset" title="Permalink to this headline">¶</a></h1>
<div class="section" id="implicit-feedback">
<h2>Implicit feedback<a class="headerlink" href="#implicit-feedback" title="Permalink to this headline">¶</a></h2>
<p>For some time, the recommender system literature focused on explicit
feedback: the Netflix prize focused on accurately reproducing the
ratings users have given to movies they watched.</p>
<p>Focusing on ratings in this way ignored the importance of taking into
account which movies the users chose to watch in the first place, and
treating the absence of ratings as absence of information.</p>
<p>But the things that we don&#8217;t have ratings for aren&#8217;t unknowns: we know
the user didn&#8217;t pick them. This reflects a user&#8217;s conscious choice, and
is a good source of information on what she thinks she might like.</p>
<p>This sort of phenomenon is described as data which is
missing-not-at-random in the literature: the ratings that are missing
are more likely to be negative precisely because the user chooses which
items to rate. When choosing a restaurant, you only go to places which
you think you&#8217;ll enjoy, and never go to places that you think you&#8217;ll
hate. What this leads to is that you&#8217;re only going to be submitting
ratings for things which, a priori, you expected to like; the things
that you expect you will not like you will never rate.</p>
<p>This observation has led to the development of models that are suitable
for implicit feedback. LightFM implements two that have proven
particular successful:</p>
<ul class="simple">
<li>BPR: Bayesian Personalised Ranking [1] pairwise loss. Maximises the
prediction difference between a positive example and a randomly
chosen negative example. Useful when only positive interactions are
present and optimising ROC AUC is desired.</li>
<li>WARP: Weighted Approximate-Rank Pairwise [2] loss. Maximises the rank
of positive examples by repeatedly sampling negative examples until
rank violating one is found. Useful when only positive interactions
are present and optimising the top of the recommendation list
(precision&#64;k) is desired.</li>
</ul>
<p>This example shows how to estimate these models on the Movielens
dataset.</p>
<p>[1] Rendle, Steffen, et al. &#8220;BPR: Bayesian personalized ranking from
implicit feedback.&#8221; Proceedings of the Twenty-Fifth Conference on
Uncertainty in Artificial Intelligence. AUAI Press, 2009.</p>
<p>[2] Weston, Jason, Samy Bengio, and Nicolas Usunier. &#8220;Wsabie: Scaling up
to large vocabulary image annotation.&#8221; IJCAI. Vol. 11. 2011.</p>
</div>
<div class="section" id="getting-the-data">
<h2>Getting the data<a class="headerlink" href="#getting-the-data" title="Permalink to this headline">¶</a></h2>
<p>The first step is to get the <a class="reference external" href="http://grouplens.org/datasets/movielens/100k/">Movielens
data</a>. This is a
classic small recommender dataset, consisting of around 950 users, 1700
movies, and 100,000 ratings. The ratings are on a scale from 1 to 5, but
we&#8217;ll all treat them as implicit positive feedback in this example.</p>
<p>Fortunately, this is one of the functions provided by LightFM itself.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">lightfm.datasets</span> <span class="k">import</span> <span class="n">fetch_movielens</span>

<span class="n">movielens</span> <span class="o">=</span> <span class="n">fetch_movielens</span><span class="p">()</span>
</pre></div>
</div>
<p>This gives us a dictionary with the following fields:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">movielens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">943</span><span class="n">x1682</span> <span class="n">sparse</span> <span class="n">matrix</span> <span class="n">of</span> <span class="nb">type</span> <span class="s1">&#39;&lt;type &#39;</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="s1">&#39;&gt;&#39;</span>
    <span class="k">with</span> <span class="mi">9430</span> <span class="n">stored</span> <span class="n">elements</span> <span class="ow">in</span> <span class="n">COOrdinate</span> <span class="nb">format</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="s1">&#39;item_features&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">1682</span><span class="n">x1682</span> <span class="n">sparse</span> <span class="n">matrix</span> <span class="n">of</span> <span class="nb">type</span> <span class="s1">&#39;&lt;type &#39;</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="s1">&#39;&gt;&#39;</span>
    <span class="k">with</span> <span class="mi">1682</span> <span class="n">stored</span> <span class="n">elements</span> <span class="ow">in</span> <span class="n">Compressed</span> <span class="n">Sparse</span> <span class="n">Row</span> <span class="nb">format</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="mi">943</span><span class="n">x1682</span> <span class="n">sparse</span> <span class="n">matrix</span> <span class="n">of</span> <span class="nb">type</span> <span class="s1">&#39;&lt;type &#39;</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="s1">&#39;&gt;&#39;</span>
    <span class="k">with</span> <span class="mi">90570</span> <span class="n">stored</span> <span class="n">elements</span> <span class="ow">in</span> <span class="n">COOrdinate</span> <span class="nb">format</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">(</span><span class="s1">&#39;item_labels&#39;</span><span class="p">,</span> <span class="n">array</span><span class="p">([</span><span class="s1">u&#39;Toy Story (1995)&#39;</span><span class="p">,</span> <span class="s1">u&#39;GoldenEye (1995)&#39;</span><span class="p">,</span> <span class="s1">u&#39;Four Rooms (1995)&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
       <span class="s1">u&#39;Sliding Doors (1998)&#39;</span><span class="p">,</span> <span class="s1">u&#39;You So Crazy (1994)&#39;</span><span class="p">,</span>
       <span class="s1">u&#39;Scream of Stone (Schrei aus Stein) (1991)&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
<span class="p">(</span><span class="s1">&#39;item_feature_labels&#39;</span><span class="p">,</span> <span class="n">array</span><span class="p">([</span><span class="s1">u&#39;Toy Story (1995)&#39;</span><span class="p">,</span> <span class="s1">u&#39;GoldenEye (1995)&#39;</span><span class="p">,</span> <span class="s1">u&#39;Four Rooms (1995)&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span>
       <span class="s1">u&#39;Sliding Doors (1998)&#39;</span><span class="p">,</span> <span class="s1">u&#39;You So Crazy (1994)&#39;</span><span class="p">,</span>
       <span class="s1">u&#39;Scream of Stone (Schrei aus Stein) (1991)&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">))</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">train</span></code> and <code class="docutils literal"><span class="pre">test</span></code> elements are the most important: they contain
the raw rating data, split into a train and a test set. Each row
represents a user, and each column an item. Entries are ratings from 1
to 5.</p>
</div>
<div class="section" id="fitting-models">
<h2>Fitting models<a class="headerlink" href="#fitting-models" title="Permalink to this headline">¶</a></h2>
<p>Now let&#8217;s train a BPR model and look at its accuracy.</p>
<p>We&#8217;ll use two metrics of accuracy: precision&#64;k and ROC AUC. Both are
ranking metrics: to compute them, we&#8217;ll be constructing recommendation
lists for all of our users, and checking the ranking of known positive
movies. For precision at k we&#8217;ll be looking at whether they are within
the first k results on the list; for AUC, we&#8217;ll be calculating the
probability that any known positive is higher on the list than a random
negative example.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">LightFM</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;bpr&#39;</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">train_precision</span> <span class="o">=</span> <span class="n">precision_at_k</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">test_precision</span> <span class="o">=</span> <span class="n">precision_at_k</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">train_auc</span> <span class="o">=</span> <span class="n">auc_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">test_auc</span> <span class="o">=</span> <span class="n">auc_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Precision: train </span><span class="si">%.2f</span><span class="s1">, test </span><span class="si">%.2f</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_precision</span><span class="p">,</span> <span class="n">test_precision</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AUC: train </span><span class="si">%.2f</span><span class="s1">, test </span><span class="si">%.2f</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_auc</span><span class="p">,</span> <span class="n">test_auc</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Precision</span><span class="p">:</span> <span class="n">train</span> <span class="mf">0.41</span><span class="p">,</span> <span class="n">test</span> <span class="mf">0.06</span><span class="o">.</span>
<span class="n">AUC</span><span class="p">:</span> <span class="n">train</span> <span class="mf">0.83</span><span class="p">,</span> <span class="n">test</span> <span class="mf">0.81</span><span class="o">.</span>
</pre></div>
</div>
<p>The WARP model, on the other hand, optimises for <a class="reference external" href="mailto:precision&#37;&#52;&#48;k---we">precision<span>&#64;</span>k---we</a> should
expect its performance to be better on precision.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">LightFM</span><span class="p">(</span><span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;warp&#39;</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit_partial</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">train_precision</span> <span class="o">=</span> <span class="n">precision_at_k</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">test_precision</span> <span class="o">=</span> <span class="n">precision_at_k</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">train_auc</span> <span class="o">=</span> <span class="n">auc_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">test_auc</span> <span class="o">=</span> <span class="n">auc_score</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Precision: train </span><span class="si">%.2f</span><span class="s1">, test </span><span class="si">%.2f</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_precision</span><span class="p">,</span> <span class="n">test_precision</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;AUC: train </span><span class="si">%.2f</span><span class="s1">, test </span><span class="si">%.2f</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">train_auc</span><span class="p">,</span> <span class="n">test_auc</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Precision</span><span class="p">:</span> <span class="n">train</span> <span class="mf">0.61</span><span class="p">,</span> <span class="n">test</span> <span class="mf">0.11</span><span class="o">.</span>
<span class="n">AUC</span><span class="p">:</span> <span class="n">train</span> <span class="mf">0.91</span><span class="p">,</span> <span class="n">test</span> <span class="mf">0.88</span><span class="o">.</span>
</pre></div>
</div>
<p>And that is exactly what we see: we get much higher <a class="reference external" href="mailto:precision&#37;&#52;&#48;10">precision<span>&#64;</span>10</a> (but
the AUC metric is also improved).</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="learning_schedules.html" class="btn btn-neutral float-right" title="Using different learning schedules" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../examples.html" class="btn btn-neutral" title="Examples" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Lyst (Maciej Kula).
    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.9',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>